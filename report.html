<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f7f6; color: #333; display: flex;
            justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px;
        }
        .container {
            width: 100%; max-width: 800px; background: #ffffff; border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.07); padding: 25px;
        }
        header {
            text-align: center; border-bottom: 1px solid #eee;
            padding-bottom: 15px; margin-bottom: 25px;
        }
        header h1 { margin: 0; color: #005a9c; }
        
        /* Updated Style */
        input[type="date"], button, select {
            width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 8px; font-size: 1em; box-sizing: border-box;  
            background-color: #fff;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        button {
            background-color: #007aff; color: white; font-weight: 600;
            border: none; cursor: pointer; transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; }
        
        table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd; padding: 12px; text-align: left;
        }
        th {
            background-color: #f9f9f9; font-weight: 600;
        }
        tr:nth-child(even) { background-color: #fdfdfd; }
        #report-area { display: none; }
        #status { text-align: center; font-size: 1.1em; color: #555; }

        /* --- ADD THIS NEW STYLE --- */
        tr.late-entry {
            background-color: #ffebee; /* Light Red */
            font-weight: 600;
        }
        /* --- END OF NEW STYLE --- */
    </style>
</head>
<body>
    
    <div class="container">
        <header>
            <h1>Daily Transport Report</h1>
        </header>

        <section id="step-select">
            <label for="report-date">Select Report Date:</label>
            <input type="date" id="report-date" required>

            <label for="trip-select">Select Trip:</label>
            <select id="trip-select" required>
                <option value="Morning">‚òÄÔ∏è Morning</option>
                <option value="Evening">üåô Evening</option>
            </select>
            <button type="button" id="btn-get-report">Get Report</button>
        </section>
        
        <p id="status"></p>

        <section id="report-area">
            <h2 id="report-title"></h2>
            <table id="report-table">
                <thead>
                    <tr>
                        <th>Route</th>
                        <th>Trip</th>
                        <th>Student Count</th>
                        <th>Time</th>
                        <th>Concerns</th>
                    </tr>
                </thead>
                <tbody id="report-body">
                    </tbody>
            </table>
        </section>
    </div>

<script>
    // -------------------------------------------------------------------------
    // --- IMPORTANT: Make sure this is your latest URL                      ---
    // -------------------------------------------------------------------------
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw_5zpSwBICLlEmCDL-gSwSVQ8xkWynQK1R4sANJPWOPiQJeMMrWv8hM600BP1aIGmIgQ/exec"; // <-- Make sure this is your latest URL

    const dateInput = document.getElementById("report-date");
    const tripSelect = document.getElementById("trip-select");
    const getReportBtn = document.getElementById("btn-get-report");
    const reportArea = document.getElementById("report-area");
    const reportTitle = document.getElementById("report-title");
    const reportBody = document.getElementById("report-body");
    const statusEl = document.getElementById("status");

    dateInput.valueAsDate = new Date();

    getReportBtn.addEventListener("click", fetchReportData);

    // --- HELPER FUNCTION ---
    /**
     * Converts a time string (e.g., "8:32" or "16:30") into total minutes.
     */
    function timeToMinutes(timeStr) {
        try {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        } catch (e) {
            console.error("Invalid time format:", timeStr);
            return 0;
        }
    }

    async function fetchReportData() {
        const date = dateInput.value;
        const trip = tripSelect.value;
        if (!date) {
            alert("Please select a date.");
            return;
        }

        getReportBtn.disabled = true;
        getReportBtn.textContent = "Loading...";
        statusEl.textContent = "Fetching report data...";
        reportArea.style.display = "none";

        try {
            const url = new URL(WEB_APP_URL);
            url.searchParams.append('report_date', date);
            url.searchParams.append('report_trip', trip); 
            url.searchParams.append('cache_bust', new Date().getTime());

            const response = await fetch(url);
            if (!response.ok) throw new Error("Network error.");

            const data = await response.json();
            if (data.status === 'error') throw new Error(data.message);

            buildTable(data, date, trip);
            statusEl.textContent = "";

        } catch (error)
        {
            console.error("Error fetching report:", error);
            statusEl.textContent = `Error: ${error.message}`;
        } finally {
            getReportBtn.disabled = false;
            getReportBtn.textContent = "Get Report";
        }
    }

    // --- THIS FUNCTION IS UPDATED ---
    function buildTable(data, date, trip) {
        const [year, month, day] = date.split('-');
        const friendlyDate = `${day}/${month}/${year}`;

        reportTitle.textContent = `Report for ${trip} - ${friendlyDate}`;
        reportArea.style.display = "block";
        reportBody.innerHTML = ""; 

        if (data.length === 0) {
            statusEl.textContent = "No entries found for this date and trip.";
            reportArea.style.display = "none";
            return;
        }

        data.sort((a, b) => {
            const routeA = parseInt(a.route.substring(1));
            const routeB = parseInt(b.route.substring(1));
            return routeA - routeB;
        });

        // --- UPDATED TIME LIMITS ---
        const morningLimit = timeToMinutes("08:20"); // 510 minutes (was 08:20)
        const eveningLimit = timeToMinutes("16:30"); // 990 minutes
        // --- END OF UPDATE ---

        for (const row of data) {
            const tr = document.createElement("tr");

            let isLate = false;
            const entryTime = timeToMinutes(row.time);

            if (row.trip === "Morning" && entryTime > morningLimit) {
                isLate = true;
            }
            if (row.trip === "Evening" && entryTime > eveningLimit) {
                isLate = true;
            }

            if (isLate) {
                tr.classList.add("late-entry");
            }

            tr.innerHTML = `
                <td>${row.route}</td>
                <td>${row.trip}</td>
                <td>${row.studentCount}</td>
                <td>${row.time}</td>
                <td>${row.concerns}</td>
            `;
            reportBody.appendChild(tr);
        }
    }

</script>
</body>
</html>
