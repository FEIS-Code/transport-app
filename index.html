<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Transport Report</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007aff; --success-color: #34c759; --morning-color: #ff9500;
            --afternoon-color: #5856d6; --light-gray: #f6f8fa; --dark-gray: #4a5568;
            --border-color: #e2e8f0; --submitted-color: #cdd5e0;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--light-gray); color: var(--dark-gray); display: flex;
            justify-content: center; align-items: center; min-height: 100vh;
            padding: 20px; box-sizing: border-box;
        }
        .container {
            width: 100%; max-width: 480px; background: #ffffff; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); padding: 32px;
        }
        header { text-align: center; margin-bottom: 24px; }
        header h1 { margin: 0; color: #1a202c; font-size: 1.75em; font-weight: 700; }
        #sub-header {
            margin: 8px 0 24px; font-size: 1.125em; color: var(--dark-gray); font-weight: 500;
            border-top: 1px solid var(--border-color); padding-top: 24px;
        }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.875em; }
        input[type="date"], input[type="number"], input[type="time"], textarea {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1em; font-family: 'Inter', sans-serif;
            box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,122,255,0.2);
        }
        textarea { resize: vertical; min-height: 80px; }
        .btn {
            width: 100%; padding: 14px 20px; margin-top: 16px; border: none;
            border-radius: 8px; font-size: 1em; font-weight: 600;
            font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #005ec4; }
        .btn-primary:disabled { background-color: var(--submitted-color); cursor: not-allowed; }
        .btn-submit { background-color: var(--success-color); color: white; }
        .btn-submit:hover { background-color: #2a9e46; }
        #step-trip { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .btn-trip {
            padding: 24px; font-size: 1.125em; font-weight: 600; border-radius: 12px;
            border: 2px solid var(--border-color); background-color: #fff;
            color: var(--dark-gray); transition: all 0.2s;
        }
        .btn-trip:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-trip[data-trip="Morning"] { border-color: var(--morning-color); }
        .btn-trip[data-trip="Morning"]:hover { background-color: var(--morning-color); color: white; }
        .btn-trip[data-trip="Afternoon"] { border-color: var(--afternoon-color); }
        .btn-trip[data-trip="Afternoon"]:hover { background-color: var(--afternoon-color); color: white; }
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 12px;
        }
        .btn-route {
            padding: 20px 10px; font-size: 1.1em; font-weight: 700; text-align: center;
            background-color: var(--light-gray); color: var(--primary-color);
            border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s;
        }
        .btn-route:hover {
            background-color: var(--primary-color); color: white;
            border-color: var(--primary-color); transform: scale(1.05);
        }
        /* --- NEW STYLE for submitted buttons --- */
        .btn-route.submitted {
            background-color: var(--submitted-color);
            color: var(--dark-gray);
            border-color: #b1bdcb;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-route.submitted:hover {
            background-color: var(--submitted-color);
            color: var(--dark-gray);
            transform: none;
        }
        .hidden { display: none; }
        #status-message { text-align: center; font-weight: 500; margin-top: 20px; font-size: 1em; }
        .success { color: var(--success-color); }
        .error { color: #e53e3e; }
    </style>
</head>
<body>
    
    <div class="container">
        <header>
            <h1>Daily Transport Report</h1>
        </header>

        <form id="transport-form">
            <h2 id="sub-header">Step 1: Select Date</h2>

            <section id="step-date">
                <label for="date">Report Date:</label>
                <input type="date" id="date" required>
                <button type="button" id="btn-next-trip" class="btn btn-primary" disabled>Next</button>
            </section>
            
            <section id="step-trip" class="hidden">
                <button type="button" class="btn-trip" data-trip="Morning" style="margin-top: 0;">‚òÄÔ∏è Morning</button>
                <button type="button" class="btn-trip" data-trip="Afternoon" style="margin-top: 0;">üåô Afternoon</button>
            </section>

            <section id="step-route" class="hidden">
                <div class="grid-container"></div>
            </section>

            <section id="step-details" class="hidden">
                <label for="student-count">Number of Students:</label>
                <input type="number" id="student-count" required style="margin-bottom: 16px;">
                
                <label for="time">Arrival/Departure Time:</label>
                <input type="time" id="time" required style="margin-bottom: 16px;">
                
                <label for="concerns">Delays or Concerns (Optional):</label>
                <textarea id="concerns" rows="3"></textarea>
                
                <button type="submit" id="btn-submit" class="btn btn-submit">Submit Log</button>
            </section>
        </form>
        
        <div id="status-message"></div>
    </div>

    <script>
        // Get the WEB APP URL from the script itself
        const WEB_APP_URL = "<?= ScriptApp.getService().getUrl() ?>";
        
        let submittedRoutes = new Set();
        const formData = { date: "", route: "", trip: "" };
        const form = document.getElementById("transport-form");
        const subHeader = document.getElementById("sub-header");
        const statusMessage = document.getElementById("status-message");
        const stepDate = document.getElementById("step-date");
        const stepRoute = document.getElementById("step-route");
        const stepTrip = document.getElementById("step-trip");
        const stepDetails = document.getElementById("step-details");
        const dateInput = document.getElementById("date");
        const nextTripButton = document.getElementById("btn-next-trip");
        const routeGrid = document.querySelector("#step-route .grid-container");

        // --- Step 1: Date ---
        dateInput.valueAsDate = new Date();
        formData.date = dateInput.value; // Store initial date
        nextTripButton.disabled = false; 

        dateInput.addEventListener("input", () => {
            formData.date = dateInput.value;
            nextTripButton.disabled = !dateInput.value;
        });

        nextTripButton.addEventListener("click", () => {
            stepDate.classList.add("hidden");
            stepTrip.classList.remove("hidden"); 
            subHeader.textContent = "Step 2: Select Trip";
        });

        // --- Step 2: Trip Buttons ---
        document.querySelectorAll(".btn-trip").forEach(button => {
            button.addEventListener("click", () => {
                formData.trip = button.dataset.trip;
                stepTrip.classList.add("hidden");
                stepRoute.classList.remove("hidden"); 
                subHeader.textContent = "Step 3: Select Route";
                // --- NEW: Fetch submitted routes and build grid ---
                buildRouteGrid();
            });
        });
        
        // --- NEW Function: Fetches data and builds buttons ---
        async function buildRouteGrid() {
            routeGrid.innerHTML = "Loading routes..."; // Show loading state
            
            try {
                // Call doGet_Form_Data
                const response = await fetch(`${WEB_APP_URL}?date=${formData.date}&trip=${formData.trip}`);
                if (!response.ok) throw new Error('Network error');
                const routesArray = await response.json();
                submittedRoutes = new Set(routesArray);
            } catch (e) {
                console.error("Error fetching routes:", e);
                submittedRoutes = new Set(); // Default to empty on error
            }

            routeGrid.innerHTML = ""; // Clear loading state
            for (let i = 1; i <= 14; i++) {
                const routeName = `R${i}`;
                const routeBtn = document.createElement("button");
                routeBtn.type = "button";
                routeBtn.className = "btn-route";
                routeBtn.textContent = routeName;
                routeBtn.dataset.route = routeName;
                
                if (submittedRoutes.has(routeName)) {
                    routeBtn.classList.add("submitted");
                    routeBtn.disabled = true;
                }
                
                routeBtn.addEventListener("click", () => {
                    if (routeBtn.classList.contains("submitted")) return;
                    
                    formData.route = routeBtn.dataset.route;
                    stepRoute.classList.add("hidden");
                    stepDetails.classList.remove("hidden");
                    subHeader.textContent = `Step 4: Details (${formData.route} - ${formData.trip})`;
                });
                
                routeGrid.appendChild(routeBtn);
            }
        }

        // --- Step 4: Form Submission ---
        form.addEventListener("submit", async (e) => {
            e.preventDefault(); 
            const submitButton = document.getElementById("btn-submit");
            submitButton.disabled = true;
            submitButton.textContent = "Submitting...";

            const finalData = {
                ...formData,
                studentCount: document.getElementById("student-count").value,
                time: document.getElementById("time").value,
                concerns: document.getElementById("concerns").value
            };

            try {
                // Call doPost
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    body: JSON.stringify(finalData),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                showStatus("Log saved successfully!", "success");
                resetForm();
            } catch (error) {
                console.error("Error:", error);
                showStatus(`Error saving log: ${error.message}`, "error");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Submit Log";
            }
        });

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = type;
        }

        function resetForm() {
            form.reset();
            dateInput.valueAsDate = new Date();
            formData.date = dateInput.value;
            nextTripButton.disabled = false;
            formData.route = "";
            formData.trip = "";
            
            stepTrip.classList.add("hidden");
            stepRoute.classList.add("hidden");
            stepDetails.classList.add("hidden");
            
            stepDate.classList.remove("hidden");
            subHeader.textContent = "Step 1: Select Date";
            showStatus("", "");
        }
    </script>
</body>
</html>
